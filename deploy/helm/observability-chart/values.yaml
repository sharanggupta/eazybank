# ============================================================================
# EazyBank Observability Stack Helm Chart Values
# ============================================================================
# This chart deploys the complete observability infrastructure for Kubernetes:
# - Prometheus (via kube-prometheus-stack) - metrics storage
# - Grafana (custom deployment) - visualization & dashboards
# - Loki - log aggregation
# - Grafana Alloy - log collection agent (DaemonSet)
# - OpenTelemetry Collector - distributed trace collection

# Global settings
global:
  environment: staging  # Override to 'prod' for production
  namespace: observability

# ============================================================================
# Kube-Prometheus-Stack (Prometheus)
# ============================================================================
kube-prometheus-stack:
  enabled: true

  # Disable Prometheus Operator - we'll use simple ServiceMonitor labels
  prometheusOperator:
    enabled: false

  # Prometheus Configuration
  prometheus:
    enabled: true
    prometheusSpec:
      retention: 15d
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: standard
            resources:
              requests:
                storage: 10Gi
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "500m"
      # Enable all ServiceMonitors regardless of namespace
      serviceMonitorSelectorNilUsesHelmValues: false
      serviceMonitorSelector: {}
      serviceMonitorNamespaceSelector: {}
    service:
      type: NodePort
      nodePort: 30090

  # Disable Grafana (we provide custom deployment)
  grafana:
    enabled: false

  # Disable other components we don't need
  alertmanager:
    enabled: false
  nodeExporter:
    enabled: false
  kubeStateMetrics:
    enabled: false
  coreDns:
    enabled: false
  kubeScheduler:
    enabled: false
  kubeControllerManager:
    enabled: false

# ============================================================================
# Standalone Grafana Configuration
# ============================================================================
prometheus:
  enabled: true  # For local compatibility

grafana:
  enabled: true
  replicas: 1

  image:
    repository: grafana/grafana
    tag: "11.0.0"
    pullPolicy: IfNotPresent

  adminUser: admin
  adminPassword: admin

  service:
    type: NodePort
    port: 3000
    nodePort: 30300

  persistence:
    enabled: true
    size: 2Gi
    storageClassName: standard

  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# ============================================================================
# Loki Configuration (Log Aggregation)
# ============================================================================
loki:
  enabled: true
  replicas: 1

  image:
    repository: grafana/loki
    tag: "3.0.0"
    pullPolicy: IfNotPresent

  service:
    type: NodePort
    port: 3100
    nodePort: 30100

  persistence:
    enabled: true
    size: 10Gi
    storageClassName: standard

  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

  # Log retention
  config:
    retention: 7d
    chunkSize: 256MB

# ============================================================================
# Grafana Alloy Configuration (Log Collection - DaemonSet)
# ============================================================================
alloy:
  enabled: true

  image:
    repository: grafana/alloy
    tag: latest
    pullPolicy: IfNotPresent

  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

  # Service for Alloy UI
  service:
    type: ClusterIP
    port: 12345
    nodePort: null

# ============================================================================
# OpenTelemetry Collector Configuration (Trace Collection)
# ============================================================================
otelCollector:
  enabled: true
  replicas: 1

  image:
    repository: otel/opentelemetry-collector-contrib
    tag: "0.97.0"
    pullPolicy: IfNotPresent

  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  # Service ports
  service:
    otlpHttp:
      port: 4318
    prometheusMetrics:
      port: 8889

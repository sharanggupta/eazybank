# =============================================================================
# Gateway Service Pipeline
# =============================================================================
#
# Triggers when:
#   - Changes pushed to customergateway/** OR
#   - Changes pushed to deploy/helm/services/customergateway/**
#   - Manual trigger via workflow_dispatch
#
# Skips if only documentation/config changes
#
# Calls the reusable deploy-service.yml workflow
#
# Note: Gateway does NOT require DB_PASSWORD since it doesn't have a database
#
# =============================================================================

name: Deploy Gateway

permissions:
  contents: write
  packages: write

on:
  push:
    branches:
      - main
    paths:
      - 'customergateway/**'
      - 'deploy/helm/services/customergateway/**'
      - '.github/workflows/deploy-customergateway.yml'
      - '.github/workflows/deploy-service.yml'
      - '.github/workflows/get-version.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/eazybank

jobs:
  deploy:
    uses: ./.github/workflows/deploy-service.yml
    with:
      service: customergateway
      registry: ghcr.io
      image_prefix: ${{ github.repository_owner }}/eazybank
    secrets:
      registry_token: ${{ secrets.GITHUB_TOKEN }}
      kube_config: ${{ secrets.KUBE_CONFIG }}
      kube_config_prod: ${{ secrets.KUBE_CONFIG_PROD }}
      db_password: ${{ secrets.DB_PASSWORD }}
      db_password_prod: ${{ secrets.DB_PASSWORD_PROD }}
      git_release_token: ${{ secrets.GITHUB_TOKEN }}
